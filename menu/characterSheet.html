<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        body {
            background-color: #000 !important; /* 背景顏色 */
        }
        
    </style>
</head>
<body>
    <!-- 返回按鈕 -->
    <div class="button-bar header" id="buttonBar">
        <button class="exit-button" onclick="goBack()">　〈 返回</button>
        <h3>　</h3>
    </div>

    <div class="main-content">
        <!-- 角色詳情 -->
        <div id="character-sheet">
        </div>
    </div>

    <script src="../script.js"></script>
    <script>
    
        // 頁面載入時
        window.onload = function() {
            showCharacterSheet(); // 顯示角色詳情
            npcPreferences(); // NPC偏好設定
        };
        
        // 顯示角色詳情
        function showCharacterSheet(memberId = null) {
            // 讀取對象id
            memberId = localStorage.getItem("npcId");

            // 讀取所有成員的資料
            const teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];

            // 找到這個成員的資料
            const member = teamMembers.find(m => m.id === memberId);
            console.log("成員", member);
            
            // 查找武器和盔甲的名稱
            const weaponName = (member.weapon && member.weapon.name) ? member.weapon.name : "（無武器）";
            const armorName = (member.armor && member.armor.name) ? member.armor.name : "（無盔甲）";

            // 計算屬性加值
            let addStr = member.str.total - member.str.basic;
            let addDex = member.dex.total - member.dex.basic;
            let addCha = member.cha.total - member.cha.basic;
            let addWis = member.wis.total - member.wis.basic;
            let addArm = member.arm.total;

            // 如果數值為正數，前面加上 `+`
            addStr = addStr > 0 ? `+${addStr}` : addStr;
            addDex = addDex > 0 ? `+${addDex}` : addDex;
            addCha = addCha > 0 ? `+${addCha}` : addCha;
            addWis = addWis > 0 ? `+${addWis}` : addWis;
            addArm = addArm > 0 ? `+${addArm}` : addArm;

            // 顯示角色詳情
            const menu = document.getElementById("character-sheet");
            menu.innerHTML = "";

            let characterDiv = document.createElement("div");
            characterDiv.innerHTML = `
                <div class="item">
                    <div class="center">${member.type}</div>
                    <div class="column-container background">
                        <button class="column-small" onclick="lastMember('${member.id}')">◀︎</button>
                        <h3 class="column center">${member.name}</h3>
                        <button class="column-small" onclick="nextMember('${member.id}')">▶︎</button>
                    </div>
                </div>

                <div class="item">
                    <span class="small">生命值</span>
                    <div class="column-container background">
                        <span class="column center hp" id="HP-bar"></span>
                        <span class="column center">${member.HP} / ${member.MaxHP}</span>
                        <span class="column center note" id="HP-description"></span>
                    </div>
                </div>

                <div class="item">
                    <span class="small">情緒</span>
                    <div class="column-container background">
                        <div class="column">
                            <span id="mood-level"></span>
                            <span class="small note" id="mood-description"></span>
                        </div>
                        <span class="column-small">${member.mood}</span>
                    </div>
                    <div id="emotion-list"></div>
                </div>
                    
                <div class="item">
                    <span class="small">屬性</span>
                    <div class="column-container background">
                        <span class="column center">🫀 體質</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.con.basic}</span>
                            <span class="column center"></span>
                        </div>
                        <span class="column center note" id="con-description"></span>
                    </div>
                    <div class="column-container background">
                        <span class="column center">⚔️ 力量</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.str.total}</span>
                            <span class="column center">(${addStr})</span>
                        </div>
                        <span class="column center note" id="str-description"></span>
                    </div>
                    <div class="column-container background">
                        <span class="column center">🏃 敏捷</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.dex.total}</span>
                            <span class="column center">(${addDex})</span>
                        </div>
                        <span class="column center note" id="dex-description"></span>
                    </div>
                    <div class="column-container background">
                        <span class="column center">👁️ 感知</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.wis.total}</span>
                            <span class="column center">(${addWis})</span>
                        </div>
                        <span class="column center note" id="wis-description"></span>
                    </div>
                    <div class="column-container background">
                        <span class="column center">✨ 魅力</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.cha.total}</span>
                            <span class="column center">(${addCha})</span>
                        </div>
                        <span class="column center note" id="cha-description"></span>
                    </div>
                    <div class="column-container background">
                        <span class="column center">🛡️ 護甲</span>
                        <div class="column row-buttons">
                            <span class="column center">${member.arm.total}</span>
                            <span class="column center">(${addArm})</span>
                        </div>
                        <span class="column center note"></span>
                    </div>
                </div>

                <div class="item">
                    <span class="small">裝備</span>
                    <div class="column-container">
                        <button class="column center" onclick="chooseEquipment(member.name, 'weapon')">${weaponName}</button>
                        <button class="column center" onclick="chooseEquipment(member.name, 'armor')">${armorName}</button>
                    </div>
                    <div id="note"></div>
                </div>
                <div id="item-list"></div>

                <div class="item">
                    <p>${member.description}</p>
                </div>
            `;
            menu.appendChild(characterDiv);

            // 顯示情緒
            showEmotion(memberId);

            // 顯示屬性描述
            document.getElementById("HP-bar").textContent = showStatDescription("HP-bar", `${member.id}`);
            document.getElementById("HP-description").textContent = showStatDescription("HP", `${member.id}`);
            document.getElementById("con-description").textContent = showStatDescription("con", `${member.id}`);
            document.getElementById("str-description").textContent = showStatDescription("str", `${member.id}`);
            document.getElementById("dex-description").textContent = showStatDescription("dex", `${member.id}`);
            document.getElementById("wis-description").textContent = showStatDescription("wis", `${member.id}`);
            document.getElementById("cha-description").textContent = showStatDescription("cha", `${member.id}`);
            
            window.scrollTo({ top: 0, behavior: "smooth" }); // 跳到畫面上方
        }

        // 顯示情緒
        function showEmotion(memberId) {
            // 找到這個成員的資料
            const teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];
            const member = teamMembers.find(m => m.id === memberId);

            // 顯示心情
            if (member.mood >= 15) {
                document.getElementById("mood-level").textContent = "❤️‍🔥 狂喜";
                document.getElementById("mood-description").textContent = "敏捷 + 2";
            } else if (member.mood >= 10) {
                document.getElementById("mood-level").textContent = "🎶 高興";
                document.getElementById("mood-description").textContent = "敏捷 + 1";
            } else if (member.mood >= 5) {
                document.getElementById("mood-level").textContent = "👍 輕鬆";
                document.getElementById("mood-description").textContent = "感知 + 1";
            } else if (member.mood <= -5) {
                document.getElementById("mood-level").textContent = "👎 不悅";
                document.getElementById("mood-description").textContent = "感知 - 1";
            } else if (member.mood <= -10) {
                document.getElementById("mood-level").textContent = "💦 焦慮";
                document.getElementById("mood-description").textContent = "敏捷 - 1";
            } else if (member.mood <= -15) {
                document.getElementById("mood-level").textContent = "💀 崩潰";
                document.getElementById("mood-description").textContent = "敏捷 - 2";
            } else {
                document.getElementById("mood-level").textContent = "👌 平靜";
            }

            // 顯示展開按鈕
            const note = `
                <div style="text-align: right">
                    <span class="note small">[詳細]</span>
                </div>
            `;
            
            document.getElementById("emotion-list").innerHTML = note;

            // 點擊時，顯示或收起情緒列表
            let itemElement = document.getElementById("emotion-list");
            let hidedElement = document.getElementById("emotion-list");

            itemElement.addEventListener("click", () => {
                if (hidedElement.innerHTML === note) {
                    // 顯示情緒
                    const menu = document.getElementById("emotion-list");
                    menu.innerHTML = "";

                    member.emotion.forEach(emotion => {
                        let emotionDiv = document.createElement("div");
                        emotionDiv.innerHTML = `
                            <div class="column-container note small">
                                <span class="column">
                                    ${emotion.name}
                                    ${emotion.note ? `（${emotion.note}）` : "" }
                                </span>
                                <span class="column-small">${emotion.mood > 0 ? "+" : ""}${emotion.mood}</span>
                            </div>
                        `;

                        menu.appendChild(emotionDiv);
                    })
                } else {
                    hidedElement.innerHTML = note;
                }
            });
        }

        // 顯示屬性描述
        function showStatDescription(stat, memberId) {
            // 讀取出戰成員
            let teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];        

            // 找到角色的資料
            member = teamMembers.find(m => m.id === memberId);

            // 顯示描述
            let description = "";
            switch (stat) {
                case "HP-bar":
                    let unit = 5 ; // 每格代表的 HP 值
                    let maxUnit = 8 ; // 格數上限
                    description = member.HP === 0 ? "" : "❚".repeat(Math.min(Math.ceil(member.HP / unit), maxUnit));
                    break;
                case "HP":
                    if (member.HP === member.MaxHP) {
                        description = "健康";
                    } else if (member.HP === 0) {
                        description = "昏迷";
                    } else if (member.HP <= member.MaxHP*0.5) {
                        description = "重傷";
                    } else {
                        description = "輕傷";
                    }
                    break;
                case "con":
                    if (member.con < 8) {
                        description = "弱不禁風";
                    } else if (member.con <= 12) {
                        description = "中等";
                    } else {
                        description = "身強體壯";
                    }
                    break;
                case "str":
                    if (member.str.total < 8) {
                        description = "軟弱無力";
                    } else if (member.str.total <= 12) {
                        description = "普通";
                    } else {
                        description = "孔武有力";
                    }
                    break;
                case "dex":
                    if (member.dex.total < 8) {
                        description = "動作笨拙";
                    } else if (member.dex.total <= 12) {
                        description = "正常";
                    } else {
                        description = "身手矯捷";
                    }
                    break;
                case "wis":
                    if (member.wis < 8) {
                        description = "少一根筋";
                    } else if (member.wis <= 12) {
                        description = "一般";
                    } else {
                        description = "明察秋毫";
                    }
                    break;
                case "cha":
                    if (member.cha.total < 8) {
                        description = "使人反感";
                    } else if (member.cha.total <= 12) {
                        description = "平凡";
                    } else {
                        description = "令人著迷";
                    }
                    break;

            }
            return description;
        }

        // 切換為上一個角色
        function lastMember(memberId) {
            // 讀取出戰成員
            let teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];        

            // 找到角色的索引
            let index = teamMembers.findIndex(m => m.id === memberId);

            // 計算上一個角色的索引
            let prevIndex = (index - 1 + teamMembers.length) % teamMembers.length;

            // 切換到上一個角色
            localStorage.setItem("npcId", teamMembers[prevIndex].id);
            showCharacterSheet(teamMembers[prevIndex].id);
        }

        // 切換為下一個角色
        function nextMember(memberId) {
            // 讀取出戰成員
            let teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];        

            // 找到角色的索引
            let index = teamMembers.findIndex(m => m.id === memberId);

            // 計算下一個角色的索引
            let nextIndex = (index + 1 + teamMembers.length) % teamMembers.length;

            // 切換到下一個角色
            localStorage.setItem("npcId", teamMembers[nextIndex].id);
            showCharacterSheet(teamMembers[nextIndex].id);
        }

        // 選擇裝備
        function chooseEquipment(memberName, itemType) {
            // 讀取對象id
            memberId = localStorage.getItem("npcId");

            // 找到這個成員身上的裝備
            const teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];
            const member = teamMembers.find(m => m.id === memberId);

            if (member[itemType] && member[itemType].id) {
                //let item = itemDatabase.find(i => i.id === member[itemType].id);
                let item = findItemData(member[itemType].id); // 從資料庫查找物品

                // 顯示裝備中的物品描述
                let note = document.getElementById("note");            
                note.innerHTML = `
                    <p class="column small note">
                        ${item.description ? `${item.description}<br>` : ""}
                        ${item.str ? `力量 ${(item.str > 0 ? `+${item.str}<br>` : item.str)}` : ""}
                        ${item.cha ? `魅力 ${(item.cha > 0 ? `+${item.cha}<br>` : item.cha)}` : ""}
                        ${item.arm ? `護甲 ${(item.arm > 0 ? `+${item.arm}<br>` : item.arm)}` : ""}
                        ${statusData[item.category] ? `[${item.category}] 造成${statusData[item.category].name}的機率 ${item.str * statusData[item.category].multiplier * 5}%` : ""}
                        ${item.heal ? `恢復 ${item.heal} HP` : ""}
                        ${item.needStr ? `（如果裝備者力量未達 ${item.needStr} 會承受敏捷 ${item.dex} 減值）` : ""}
                    </p>
                `;
            }

            // 讀取主角的物品
            let playerItems = JSON.parse(localStorage.getItem("playerItems")) || [];

            // 統計物品數量
            let count = {};
            playerItems.forEach(item => {
                count[item] = (count[item] || 0) + 1;
            });

            // 顯示物品列表
            let itemList = document.getElementById("item-list");            
            itemList.innerHTML = "";

            Object.keys(count).forEach(itemId => {
                //let item = itemDatabase.find(i => i.id === itemId); // 從資料庫查找物品
                let item = findItemData(itemId); // 從資料庫查找物品

                // 顯示這個類型的裝備，隱藏其他人的專屬裝備
                if (item && item.type === itemType && (!item.owner || item.owner === memberName)) {
                    let itemDiv = document.createElement("div");
                    itemDiv.classList.add("item", "background");

                    itemDiv.innerHTML = `
                        <div class="column-container" style="cursor: pointer;">
                            <span class="column">${item.name} × ${count[itemId]}</span>
                            <button style="margin:0 5px; padding: 5px 15px;" onclick="(equip(memberId, '${item.id}'), showCharacterSheet())">
                                <span class="small">選擇</span>
                            </button>
                        </div>
                        <div class="hided" style="display: none;">
                            <p class="column small note">
                                ${item.description ? `${item.description}<br>` : ""}
                                ${item.str ? `力量 ${(item.str > 0 ? `+${item.str}<br>` : item.str)}` : ""}
                                ${item.cha ? `魅力 ${(item.cha > 0 ? `+${item.cha}<br>` : item.cha)}` : ""}
                                ${item.arm ? `護甲 ${(item.arm > 0 ? `+${item.arm}<br>` : item.arm)}` : ""}
                                ${item.dex && !item.needStr ? `敏捷 ${(item.dex > 0 ? `+${item.dex}` : item.dex)}<br>` : ""}
                                ${statusData[item.category] ? `[${item.category}] 造成${statusData[item.category].name}的機率 ${item.str * statusData[item.category].multiplier * 5}%` : ""}
                                ${item.heal ? `恢復 ${item.heal} HP` : ""}
                                ${item.needStr ? `（如果裝備者力量未達 ${item.needStr} 會承受敏捷 ${item.dex} 減值）` : ""}
                            </p>
                        </div>
                    `;

                    // 點擊物品時，顯示或隱藏描述
                    let itemElement = itemDiv.querySelector(".column-container");
                    let hidedElement = itemDiv.querySelector(".hided");

                    itemElement.addEventListener("click", () => {
                        hidedElement.style.display = (hidedElement.style.display === "none") ? "block" : "none";
                        
                    });

                    itemList.appendChild(itemDiv);
                }
            });

            // 添加「無」的按鈕
            let unequipButtonDiv = document.createElement("div");

            if (itemType === "weapon") {
                unequipButtonDiv.innerHTML = `
                    <div class="menu">
                        <button onclick="(equip(memberId, 'noWeapon'), showCharacterSheet())">
                            卸下武器
                        </button>
                    </div>
                `;
            } else if (itemType === "armor") {
                unequipButtonDiv.innerHTML = `
                    <div class="menu">
                        <button onclick="(equip(memberId, 'noArmor'), showCharacterSheet())">
                            脫下盔甲
                        </button>
                    </div>
                `;
            }

            itemList.appendChild(unequipButtonDiv);
        }

    </script>

</body>
</html>
