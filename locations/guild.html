<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公會</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        body {
        }

    </style>
</head>
<body>
    <!-- 按鈕列 -->
    <div id="buttonBar"></div>

    <!-- 通知框 -->
    <div id="toast-container"></div>

    <!-- 主要內容區域 -->
    <div id="main" class="main-content">
        <div class="header">    
            <button class="exit-button" onclick="goTo('locations/town')">〈 離開</button>
            <h1>公會</h1>
        </div>

        <p id="text">這裡是冒險者公會，牆上張貼著各種任務資訊。</p>
        <p class="small">
            🪙 <span id="playerMoney"></span><br>
            ⭐ <span id="playerFame"></span>
        </p>

        <!-- 選單 -->
        <div id="menu" class="menu">
            <button onclick="showMissionList('quest')">查看委託</button>
            <button onclick="showMissionList('task')">查看兼職</button>
            <button onclick="lostProperty()">失物招領</button>
            <button onclick="showDialogue('start')">💬 和接待員交談</button>
        </div>

        <!-- 任務列表 -->
        <div id="list"></div>
        <br><br>

        <!-- Top按紐 -->
        <button class="top-button" onclick="goTop()"></button>
    </div>

    <!-- 對話區域 -->
    <div id="dialogue" class="main-content"></div>

    </div>

    <script src="../script.js" defer></script>
    <script>
        // 畫面載入時
        window.onload = function() {
            loadPartyData();
            removeDialogue(); // 清除對話
            getDialogueNpc(); // 判斷交談對象
            checkMissions(); // 檢查任務是否完成

            preferences(); // 偏好設定
            showButtonBar(); // 顯示按鈕列
            loadBackground("guild"); // 讀取背景
        };

        // 對話資料庫
        const dialogueData = {
            "羅文": {
                // 聊天
                    "start": {
                        npc: "npc",
                        text: "你好，歡迎來到冒險者公會，有什麼需要說明的嗎？",
                        choices: [
                            { text: "要怎麼完成任務？", next: "關於任務" },
                            { text: "和我說說你的事", next: "關於接待員" },
                            { text: "附近有什麼傳聞", next: "傳聞" },
                            { text: "沒事", next: "", action: "removeDialogue()" },
                        ]
                    },
                        "關於任務": {
                            npc: "npc",
                            text: "你可以在這裡承接兼職和委託，兼職是較為簡單的日常工作，委託則具有挑戰性，完成委託可以提升你的名聲。<br><br>當你完成任務後，別忘了回到公會提交結果，才能領取報酬喔。",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },
                        "關於名聲": {
                            npc: "npc",
                            text: "",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },
                        "關於接待員": {
                            npc: "npc",
                            text: "我很熱愛這份工作，能幫助鎮民解決問題，還能夠看著新一代的冒險者成長。<br><br>我認為只要努力一定會有收穫，即使失敗也會獲得寶貴的經驗，所以請不要害怕失敗，勇往直前吧。",
                            choices: [
                                { text: "原來如此", next: "start" },
                            ]
                        },
                        "傳聞": {
                            npc: "npc",
                            text: "森林裡棲息著很多野獸，我聽說很多人在森林裡遭到襲擊，為了安全，還是盡量避免進入森林吧。",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },

                // 提交任務
                    "提交：送貨成功": {
                        npc: "npc",
                        text: "辛苦了，冒險者，你將包裹平安送到了晨曦鎮，鎮民將會感謝你的努力。<br><br>這是你的酬勞 ${price}，請收下。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：送貨失敗": {
                        npc: "npc",
                        text: "喔不，你送來的包裹遭到了損壞。<br><br>很抱歉，根據規定你必須支付賠償金 ${price}。",
                        choices: [
                            { text: "支付", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：懸賞逃犯": {
                        npc: "npc",
                        text: "冒險者，你逮捕了逃犯，讓正義獲得了伸張。<br><br>感謝你的努力，請收下 ${price} 的報酬。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                        "背叛盜賊": {
                            npc: "speaker",
                            text: "你要把我交出去？我以為我們是同伴！你這個叛徒！",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛獸人": {
                            npc: "speaker",
                            text: "人類，你竟敢出賣我！我絕對不會放過你的！聽到了嗎？",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛狼人": {
                            npc: "speaker",
                            text: "你！背叛我！為什麼？為什麼——",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛吸血鬼": {
                            npc: "speaker",
                            text: "原來你自願和我同行，全是虛情假意，你的心比吸血鬼的心臟更加冰冷……",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                    "提交：狩獵哥布林": {
                        npc: "npc",
                        text: "做得好，我們會對這個哥布林進行教育，讓他對社會做出貢獻。<br><br>這是你的報酬 ${price}。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                        "背叛哥布林": {
                            npc: "speaker",
                            text: "主人！為什麼？不要把我賣掉，求求你！",
                            choices: [
                                { text: "（繼續）", next: "提交：狩獵哥布林" },
                            ]
                        },
                    "提交：收集種子": {
                        npc: "npc",
                        text: "辛苦了，收集了這麼多種子，請收下你的報酬 ${price}。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：失竊的紅寶石": {
                        npc: "npc",
                        text: "太好了，冒險者，你成功取回了失竊的紅寶石。<br><br>這顆寶石本身並不貴重，但對委託人有重要的意義，它的價值是無法用金錢衡量的。<br><br>我代表委託人感謝你的付出，請收下 ${price} 報酬。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：吸血鬼擄走的孩子": {
                        npc: "npc",
                        text: "那個孩子沒有活下來是嗎？真是太令人難過了。<br><br>很抱歉，冒險者，因為任務沒有完成，我不能將報酬交給你。",
                        choices: [
                            { text: "好吧", next: "", action: "checkMissions()" },
                        ]
                    },

                // 組隊承接
                    "組隊承接": {
                        npc: "npc",
                        text: "這是一個有挑戰性的任務，你想和其他冒險者組隊嗎？<br><br>他們會和你一起冒險，直到任務完成，並和你平分任務報酬。<br><br>但要提醒你一下，即使中途遣散隊員，當你完成任務時，報酬依舊會分配給現在登記的隊員喔。",
                        choices: [
                            { text: "有哪些冒險者？", next: "隊員介紹" },
                            { text: "我不需要組隊了", next: "不組隊" },
                        ]
                    },
                    "不組隊": {
                        npc: "npc",
                        text: "沒關係，如果你還需要夥伴，也可以到酒館雇用有空的冒險者喔。",
                        choices: [
                            { text: "知道了", next: "", action: "removeDialogue()" },
                        ]
                    },

                    "隊員介紹": {
                        npc: "npc",
                        text: "這些是登記在公會的冒險者名單，你比較想了解哪一位？我可以為你介紹。",
                        choices: [
                            { text: "雷納德（人類戰士）", condition: "!isCompanion('雷納德')", next: "關於雷納德" },
                            { text: "塔爾穆克（獸人戰士）", condition: "!isCompanion('塔爾穆克')", next: "關於塔爾穆克" },
                            { text: "賽恩（刺客）", condition: "!isCompanion('賽恩')", next: "關於賽恩" },
                            { text: "艾德蒙（人類戰士）", condition: "!isCompanion('艾德蒙')", next: "關於艾德蒙" },
                            { text: "諾伊爾（精靈遊俠）", condition: "!isCompanion('諾伊爾')", next: "關於諾伊爾" },
                            { text: "我不需要組隊了", next: "不組隊" },
                        ]
                    },
                        "關於雷納德": {
                            npc: "npc",
                            text: "啊，雷納德，他是一位正直又善良的勇者，非常熱心助人。<br><br>他各方面的能力都很優秀，一把可靠的巨劍是他的老戰友。<br><br>而且他有個堅持，就是不收任何酬勞。只要你願意，他會免費加入你的隊伍。",
                            choices: [
                                { text: "我要和雷納德組隊", next: "隊員加入", action: "(addCompanion(null, '雷納德', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於塔爾穆克": {
                            npc: "npc",
                            text: "塔爾穆克是我們最勇猛的戰士，雖然脾氣有點嚇人，但到目前為止他還算守規矩。<br><br>他是個高大魁武的獸人，揮舞著一把引以為傲的戰斧，能擔當隊伍的肉盾。",
                            choices: [
                                { text: "我要和塔爾穆克組隊", next: "隊員加入", action: "(addCompanion(null, '塔爾穆克', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於賽恩": {
                            npc: "npc",
                            text: "我承認我對賽恩不是很了解，他總是蒙著面，也不太說話。<br><br>但他的戰鬥表現很不錯，能用匕首精準刺殺目標，來無影去無蹤。<br><br>只是有人說……噢，沒什麼，傳聞不可靠啦。",
                            choices: [
                                { text: "我要和賽恩組隊", next: "隊員加入", action: "(addCompanion(null, '賽恩', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於艾德蒙": {
                            npc: "npc",
                            text: "艾德蒙嗎？雖然他的能力不是最突出的，但他是個活潑開朗的人。<br><br>他有一把單手劍，不幸的是他弄丟了，所以你可能會需要借他武器。",
                            choices: [
                                { text: "我要和艾德蒙組隊", next: "隊員加入", action: "(addCompanion(null, '艾德蒙', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於諾伊爾": {
                            npc: "npc",
                            text: "諾伊爾是來自遙遠國度的高等精靈，你一眼就能認出這位美少年，雖然我猜他比我們都還年長。<br><br>他的體力不是很好，但身輕如燕，非常敏捷，使用一把優雅的短弓。",
                            choices: [
                                { text: "我要和諾伊爾組隊", next: "隊員加入", action: "(addCompanion(null, '諾伊爾', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                    "隊員加入": {
                        npc: "npc",
                        text: "好的，我這就通知他過來。還想選擇其他隊友嗎？<br><br>隊友越多越安心，但相對地，你分到的報酬就會越少喔。",
                        choices: [
                            { text: "再看看其他人", next: "隊員介紹" },
                            { text: "確定組隊", next: "", action: "removeDialogue()" },
                        ]
                    },

                // 失物招領
                    "有失物": {
                        text: "成堆無人認領的背包，屬於無名的冒險者們。<br><br>你認出其中一個背包是你的，裡面的錢和物品都完好如初。<br><br>但你需要支付 $100 的保管費才能領回。",
                        choices: [
                            { text: "支付 $100", next: "", condition: "hasItem('$100')", action: "(loseItem('$100'), itemsBack(), removeDialogue())" },
                            { text: "離開", next: "", action: "removeDialogue()" },
                        ]
                    },
                    "沒有失物": {
                        text: "成堆無人認領的背包，屬於無名的冒險者們。<br><br>你目前沒有遺失物品。",
                        choices: [
                            { text: "離開", next: "", action: "removeDialogue()" },
                        ]
                    },

                // 陪雷納德見夥伴1
                    "陪雷納德見夥伴1": {
                        text: "雷納德猶豫不決地走進了公會，眼神飄向四周圍。",
                        choices: [
                            { text: "你的夥伴在這嗎？", next: "陪雷納德見夥伴1-2" },
                        ]
                    },
                    "陪雷納德見夥伴1-2": {
                        npc: "雷納德",
                        text: "是啊，他在……",
                    },
                    "陪雷納德見夥伴1-3": {
                        npc: "npc",
                        text: "你們好，冒險者，有什麼問題嗎？",
                    },
                    "陪雷納德見夥伴1-4": {
                        npc: "npc",
                        text: "咦？雷納德？你終於想到要來公會了啊？<br><br>真是令人懷念，以前我們一起組隊時，你總是想包攬所有的任務。",
                    },
                    "陪雷納德見夥伴1-5": {
                        npc: "雷納德",
                        text: "對不起，羅文，我早該來的，但我沒臉見你們。<br><br>過去的事我真的很抱歉，我沒有一天不想著怎麼贖罪。",
                    },
                    "陪雷納德見夥伴1-6": {
                        npc: "npc",
                        text: "欸？有什麼好道歉的？<br><br>我知道你需要時間恢復，等你準備好自然就會來了。<br><br>我有時候會看到你在野外打怪，看樣子你恢復得不錯，太好了。",
                    },
                    "陪雷納德見夥伴1-7": {
                        npc: "雷納德",
                        text: "羅文，你還是這麼溫柔……<br><br>是我害你變成包庇罪人的共犯，被自己的國家放逐，你為什麼不埋怨我？",
                    },
                    "陪雷納德見夥伴1-8": {
                        npc: "npc",
                        text: "你到現在還在自責嗎？我說過了，那不是你的錯。<br><br>而且這個小地方也沒什麼不好，生活清靜，戴瑞跟我還可以天天去散步。",
                    },
                    "陪雷納德見夥伴1-9": {
                        npc: "npc",
                        text: "你去見戴瑞了嗎？他一定會很開心的。<br><br>雖然他絕對不會承認，但他一直很想你喔。",
                    },
                    "陪雷納德見夥伴1-10": {
                        npc: "雷納德",
                        text: "是嗎……我會去找戴瑞的。<br><br>謝謝你，羅文，和你說話讓我如釋重負。",
                    },
                    "陪雷納德見夥伴1-11": {
                        npc: "雷納德",
                        text: "{playerName}，也謝謝你陪我來。<br><br>如果可以的話，再跟我去一趟鐵石鎮的公會好嗎？",
                        choices: [
                            { text: "好", next: "陪雷納德見夥伴1-12" },
                            { text: "有空就去", next: "陪雷納德見夥伴1-12" },
                        ]
                    },
                    "陪雷納德見夥伴1-12": {
                        npc: "雷納德",
                        text: "沒問題。",
                        choices: [
                            { text: "（繼續）", action: "(turnSwitch('陪雷納德見夥伴2'), removeDialogue())" },
                        ]
                    },

            },

            "戴瑞": {
                // 聊天
                    "start": {
                        npc: "npc",
                        text: "嗯？幹嘛？",
                        choices: [
                            { text: "要怎麼完成任務？", next: "關於任務" },
                            { text: "和我說說你的事", next: "關於接待員" },
                            { text: "附近有什麼傳聞", next: "傳聞" },
                            { text: "沒事", next: "", action: "removeDialogue()" },
                        ]
                    },
                        "關於任務": {
                            npc: "npc",
                            text: "任務的要求不是都寫在上面了嗎？自己看啊。<br><br>事情做完了不要忘記回來領錢。",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },
                        "關於名聲": {
                            npc: "npc",
                            text: "",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },
                        "關於接待員": {
                            npc: "npc",
                            text: "我看起來是很閒嗎？我每天忙著填表格、發錢，還要幫忙擦屁股。<br><br>有一些不自量力的蠢蛋接了任務又做不到，你覺得誰要負責想辦法給委託人一個交代？還不是我？",
                            choices: [
                                { text: "原來如此", next: "start" },
                            ]
                        },
                        "傳聞": {
                            npc: "npc",
                            text: "我對八卦沒興趣，你幹嘛問東問西的？",
                            choices: [
                                { text: "知道了", next: "start" },
                            ]
                        },

                // 提交任務
                    "提交：送貨成功": {
                        npc: "npc",
                        text: "送包裹的啊？終於到了，我還以為你在路上掛了呢。<br><br>運費 ${price} 對吧？拿去吧。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：送貨失敗": {
                        npc: "npc",
                        text: "啊？這坨垃圾是包裹嗎？搞什麼，這樣收件人會抓狂的啊。<br><br>沒辦法了，你拿 ${price} 出來賠吧。",
                        choices: [
                            { text: "支付", next: "", action: "checkMissions()" },
                        ]
                    },
                    "提交：懸賞逃犯": {
                        npc: "npc",
                        text: "這傢伙是誰啊？喔，逃犯，希望牢房還有空間……<br><br>拿去，你的賞金 ${price} 。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                        "背叛盜賊": {
                            npc: "speaker",
                            text: "你要把我交出去？我以為我們是同伴！你這個叛徒！",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛獸人": {
                            npc: "speaker",
                            text: "人類，你竟敢出賣我！我絕對不會放過你的！聽到了嗎？",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛狼人": {
                            npc: "speaker",
                            text: "你！背叛我！為什麼？為什麼——",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                        "背叛吸血鬼": {
                            npc: "speaker",
                            text: "原來你自願和我同行，全是虛情假意，你的心比吸血鬼的心臟更加冰冷……",
                            choices: [
                                { text: "（繼續）", next: "提交：懸賞逃犯" },
                            ]
                        },
                    "提交：狩獵哥布林": {
                        npc: "npc",
                        text: "抓到哥布林了？嗯，這大概能填補一點勞動力，一個 ${price} 。<br><br>不必有罪惡感，他們在野外的命運只會更慘。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },
                        "背叛哥布林": {
                            npc: "speaker",
                            text: "主人！為什麼？不要把我賣掉，求求你！",
                            choices: [
                                { text: "（繼續）", next: "提交：狩獵哥布林" },
                            ]
                        },
                    "提交：收集種子": {
                        npc: "npc",
                        text: "別把那東西拿過來。那裡有個鐵罐，裝進去鎖起來。 ${price} 拿去吧。",
                        choices: [
                            { text: "收下", next: "", action: "checkMissions()" },
                        ]
                    },

                // 組隊承接
                    "組隊承接": {
                        npc: "npc",
                        text: "要找人組隊？那些傢伙閒著沒事都泡在隔壁的酒館，叫一聲就來了。<br><br>但你要確定喔，你的報酬會跟那些人平分，而且就算領錢之前把他們踢掉，他們還是會分到錢。<br><br>這是規定，別怪我沒提醒你。",
                        choices: [
                            { text: "有哪些冒險者？", next: "隊員介紹" },
                            { text: "我不需要組隊了", next: "不組隊" },
                        ]
                    },
                    "不組隊": {
                        npc: "npc",
                        text: "是啊，幹嘛跟人分錢？",
                        choices: [
                            { text: "再見", next: "", action: "removeDialogue()" },
                        ]
                    },
                    "隊員介紹": {
                        npc: "npc",
                        text: "目前就這些人，不要問我他們是幹什麼的，你挑個順眼的名字就好了。",
                        choices: [
                            { text: "雷納德（人類戰士）", condition: "!isCompanion('雷納德')", next: "關於雷納德" },
                            { text: "塔爾穆克（獸人戰士）", condition: "!isCompanion('塔爾穆克')", next: "關於塔爾穆克" },
                            { text: "賽恩（刺客）", condition: "!isCompanion('賽恩')", next: "關於賽恩" },
                            { text: "艾德蒙（人類戰士）", condition: "!isCompanion('艾德蒙')", next: "關於艾德蒙" },
                            { text: "諾伊爾（精靈遊俠）", condition: "!isCompanion('諾伊爾')", next: "關於諾伊爾" },
                            { text: "我不需要組隊了", next: "不組隊" },
                        ]
                    },
                        "關於雷納德": {
                            npc: "npc",
                            text: "雷納德？那個濫好人是專門做白工的，操死他吧，不用分他錢。<br><br>如果他開始唸東唸西，就直接叫他滾。",
                            choices: [
                                { text: "我要和雷納德組隊", next: "隊員加入", action: "(addCompanion(null, '雷納德', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於塔爾穆克": {
                            npc: "npc",
                            text: "這種奇怪的名字，聽起來就是獸人。獸人會來當冒險者，通常都是被部落淘汰的廢物。",
                            choices: [
                                { text: "我要和塔爾穆克組隊", next: "隊員加入", action: "(addCompanion(null, '塔爾穆克', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於賽恩": {
                            npc: "npc",
                            text: "有這個人？沒印象，大概是個廢物。",
                            choices: [
                                { text: "我要和賽恩組隊", next: "隊員加入", action: "(addCompanion(null, '賽恩', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於艾德蒙": {
                            npc: "npc",
                            text: "給艾德蒙一點工作做也好，他還欠一屁股債呢。<br><br>啊，不過……那個白癡連自己的劍都輸掉了，你有多的武器嗎？",
                            choices: [
                                { text: "我要和艾德蒙組隊", next: "隊員加入", action: "(addCompanion(null, '艾德蒙', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                        "關於諾伊爾": {
                            npc: "npc",
                            text: "是那個血統高貴的小鬼，看起來弱得要命，誰會想帶這種拖油瓶？",
                            choices: [
                                { text: "我要和諾伊爾組隊", next: "隊員加入", action: "(addCompanion(null, '諾伊爾', '冒險者'), shareReward())" },
                                { text: "再看看其他人", next: "隊員介紹" },
                            ]
                        },
                    "隊員加入": {
                        npc: "npc",
                        text: "我吹個口哨，他馬上就會到門口。<br><br>確定你的隊伍就是這些人了嗎？",
                        choices: [
                            { text: "再看看其他人", next: "隊員介紹" },
                            { text: "確定組隊", next: "", action: "removeDialogue()" },
                        ]
                    },

                // 失物招領
                    "有失物": {
                        text: "成堆無人認領的背包，屬於無名的冒險者們。<br><br>你認出其中一個背包是你的，裡面的錢和物品都完好如初。<br><br>但你需要支付 $100 的保管費才能領回。",
                        choices: [
                            { text: "支付 $100", next: "", condition: "hasItem('$100')", action: "(loseItem('$100'), itemsBack(), removeDialogue())" },
                            { text: "離開", next: "", action: "removeDialogue()" },
                        ]
                    },
                    "沒有失物": {
                        text: "成堆無人認領的背包，屬於無名的冒險者們。<br><br>你目前沒有遺失物品。",
                        choices: [
                            { text: "離開", next: "", action: "removeDialogue()" },
                        ]
                    },

                // 陪雷納德見夥伴2
                    "陪雷納德見夥伴2": {
                        text: "戴瑞在櫃台後露出疑惑的眼神，你發現雷納德躲在門外，無法下定決心。",
                        choices: [
                            { text: "你做得到", next: "陪雷納德見夥伴2-2" },
                            { text: "改天再來吧", next: "陪雷納德見夥伴2_放棄" },
                        ]
                    },
                    "陪雷納德見夥伴2_放棄": {
                        npc: "雷納德",
                        text: "也好……",
                        choices: [
                            { text: "（繼續）", action: "removeDialogue()" },
                        ]
                    },
                    "陪雷納德見夥伴2-2": {
                        npc: "雷納德",
                        text: "你說的對……難道面對朋友會比面對強敵還可怕嗎？我不該再這麼軟弱了。",
                    },
                    "陪雷納德見夥伴2-3": {
                        npc: "npc",
                        text: "喂，跟變態一樣躲在門外偷瞄，以為我沒看到嗎？<br><br>你來幹什麼？這麼多年不聞不問，早就當沒你這個人了。<br><br>說話啊，跟雕像一樣站在那裡，來讓我看了礙眼的嗎？",
                    },
                    "陪雷納德見夥伴2-4": {
                        npc: "雷納德",
                        text: "戴瑞……對不起，我……我這就走。",
                    },
                    "陪雷納德見夥伴2-5": {
                        npc: "npc",
                        text: "我話還沒說完，雷納德，你想去哪？又要等五年後才能見到你了嗎？<br><br>你這白癡，要是我能走路，我就拿這根拐杖往你頭上敲了。",
                    },
                    "陪雷納德見夥伴2-6": {
                        npc: "雷納德",
                        text: "啊……這麼說你的腿還是……",
                    },
                    "陪雷納德見夥伴2-7": {
                        npc: "npc",
                        text: "別假裝你關心，你這五年來不是完全不在乎嗎？狼心狗肺的垃圾。<br><br>你他媽的敢露出同情的眼神，我就殺了你。",
                    },
                    "陪雷納德見夥伴2-8": {
                        npc: "雷納德",
                        text: "我很在乎，戴瑞，我從沒忘記是我把你害成這樣的。<br><br>我想道歉，我想彌補你，但我又擔心你見到我會想起那一天的事。<br><br>我不知道你是不是會對我感到恐懼、憤怒……",
                    },
                    "陪雷納德見夥伴2-9": {
                        npc: "npc",
                        text: "恐懼？哈哈！誰會恐懼你這個大蠢豬？你只會把我氣死。<br><br>想彌補的話，你從明天開始每天早上到這裡罰站，舉著「我是膽小鬼」的牌子讓大家看。",
                    },
                    "陪雷納德見夥伴2-10": {
                        npc: "雷納德",
                        text: "你是認真的嗎？你……你願意讓我來這裡嗎？",
                    },
                    "陪雷納德見夥伴2-11": {
                        npc: "npc",
                        text: "你耳聾啊？我叫你每天過來。<br><br>你敢不來我就公告懸賞你，不論死活，聽見沒？",
                    },
                    "陪雷納德見夥伴2-12": {
                        text: "雷納德露出舒心的笑容，彷彿對方剛剛擁抱了他一樣。<br><br>他繼續站在那讓戴瑞教訓了十幾分鐘，眼中充滿感激。",
                    },
                    "陪雷納德見夥伴2-13": {
                        npc: "雷納德",
                        text: "今天真的謝謝你了，{playerName}。<br><br>要不是你，我一定還在獨自煩惱，永遠無法踏出第一步。<br><br>以後有什麼需要我出力的，請你儘管開口。",
                        choices: [
                            { text: "不必客氣", action: "(turnSwitch('陪雷納德見夥伴3'), getEmotion('雷納德', 'reconciliation'), removeDialogue())" },
                        ]
                    },
            },
        };

        // 顯示文本
        const texts = {
            tasks: "兼職適合想在冒險途中順便賺外快的冒險者。",
            quests: "委託適合有實力的冒險者，完成民眾的請求，能讓冒險者名聲水漲船高。一次只能進行一件委託。",
            choosePrisoner: "要把誰交出去？",
        };

        // 逃犯資料庫
        const name = ["盜賊", "獸人", "狼人", "吸血鬼"];
        const adj = ["平凡", "醜陋", "猙獰", "英俊", "美豔", "清秀", "蒼白", "黝黑", "刀疤", "年輕", "年長", "滄桑", "纖細", "圓潤", "壯碩", "矮小", "高大"];

        // 判斷交談對象
        function getDialogueNpc() {
            // 讀取主角位置
            const playerPos = JSON.parse(localStorage.getItem("playerPos"));

            let npcName;

            if (playerPos.id === "town01") {
                npcName = "羅文";
            } else if (playerPos.id === "town02") {
                npcName = "戴瑞";
            }

            localStorage.setItem("npcName", npcName);
            console.log(localStorage.getItem("npcName"));
        }

        // 任務列表
        const missions = [
            // 兼職
            { id: "task01", type: "task", name: "送貨", startPos: ["town02"], description: "將包裹送到晨曦鎮，按件計酬，但若包裹在運送過程中損壞，必須賠償雙倍運費。", price: 10, status: "" },
            { id: "task02", type: "task", name: "送貨", startPos: ["town01"], description: "將包裹送到鐵石鎮，按件計酬，但若包裹在運送過程中損壞，必須賠償雙倍運費。", price: 10, status: "" },
            { id: "task03", type: "task", name: "懸賞逃犯", startPos: ["town01", "town02"], description: "這些為非作歹的逃犯目前躲在荒野中，請協助逮捕，讓他們接受法律制裁。", price: 50, status: "" },
            { id: "task04", type: "task", name: "狩獵哥布林", startPos: ["town01", "town02"], description: "哥布林一直在破壞城鎮的安寧，請協助活捉哥布林，不要殺害他們，我們會教他們改過向善。", price: 20, status: "" },
            { id: "task05", type: "task", name: "收集種子", startPos: ["town01", "town02"], description: "食人花的種子能做成美味佳餚，但要取得必須冒著生命危險，如果有 10 個我就高價收購。", price: 200, status: "" },

            // 委託
            { id: "quest01", type: "quest", name: "失竊的紅寶石", startPos: ["town01"], description: "一顆稀有的紅寶石失竊了，我們知道下手的盜賊團躲在哪，希望有人能從他們的巢穴中取回寶石。", price: 600, status: "" },
            { id: "quest02", type: "quest", name: "吸血鬼擄走的孩子", startPos: ["town01"], description: "吸血鬼擄走了一個孩子，囚禁在一座古堡的地牢裡，去營救的守衛也有去無回，希望勇者出手相助。", price: 500, status: "" },
            { id: "quest03", type: "quest", name: "奴隸的復仇", startPos: ["town02"], description: "我曾經為了一袋金幣淪為獸人的奴隸，現在我自由了，我要復仇！讓那個渾蛋嚐嚐同樣的滋味！", price: 400, status: "" },
            { id: "quest04", type: "quest", name: "協尋丈夫", startPos: ["town02"], description: "丈夫在月圓之夜變成狼人，離家出走了，希望有人能帶他回家。不過，請先制伏他再帶回來。", price: 600, status: "" }
        ];

        // 檢查任務是否完成
        function checkMissions() {
            removeDialogue();

            const playerPos = JSON.parse(localStorage.getItem("playerPos"));
            let playerItems = JSON.parse(localStorage.getItem("playerItems")) || [];
            let teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];
            let takenMissions = JSON.parse(localStorage.getItem("takenMissions")) || [];
            let package, packageDamaged, price;

            // 檢查並更新任務狀態
            takenMissions.forEach(mission => {
                // 送貨到晨曦鎮（自動提交，因為不會顯示在收件地的任務列表中）
                if (mission.id === "task01" && playerPos.id === "town01") {
                    // 計算包裹數量
                    const packageCount = playerItems.filter(i => i === "package01").length;
                    if (packageCount > 0) {
                        // 送達，增加金錢，乘上包裹數量
                        price = mission.price * packageCount;
                        getItem("$" + price);

                        // 從物品中移除已送達的包裹
                        playerItems = playerItems.filter(i => i !== "package01");
                        localStorage.setItem("playerItems", JSON.stringify(playerItems));

                        showDialogue("提交：送貨成功", price);
                        return;
                    }

                    // 計算損壞的包裹數量
                    const damagedCount = playerItems.filter(i => i === "package01_damaged").length;
                    if (damagedCount > 0) {
                        // 包裹損壞，扣除雙倍金錢，乘上損壞包裹數量
                        price = mission.price * 2 * damagedCount;
                        getItem("$" - price);

                        // 從物品中移除損壞的包裹
                        playerItems = playerItems.filter(i => i !== "package01_damaged");
                        localStorage.setItem("playerItems", JSON.stringify(playerItems));
                        
                        showDialogue("提交：送貨失敗", price);
                        return;
                    }
                    takenMissions = takenMissions.filter((m) => m.id !== mission.id); // 清除任務
                    localStorage.setItem("takenMissions", JSON.stringify(takenMissions));

                // 送貨到鐵石鎮（自動提交，因為不會顯示在收件地的任務列表中）
                } else if (mission.id === "task02" && playerPos.id === "town02") {
                    // 計算包裹數量
                    const packageCount = playerItems.filter(i => i === "package02").length;
                    if (packageCount > 0) {
                        // 送達，增加金錢，乘上包裹數量
                        price = mission.price * packageCount;
                        getItem("$" + price);

                        // 從物品中移除已送達的包裹
                        playerItems = playerItems.filter(i => i !== "package02");
                        localStorage.setItem("playerItems", JSON.stringify(playerItems));

                        showDialogue("提交：送貨成功", price);
                        return;
                    }

                    // 計算損壞的包裹數量
                    const damagedCount = playerItems.filter(i => i === "package02_damaged").length;
                    if (damagedCount > 0) {
                        // 包裹損壞，扣除雙倍金錢，乘上損壞包裹數量
                        price = mission.price * 2 * damagedCount;
                        getItem("$" - price);

                        // 從物品中移除損壞的包裹
                        playerItems = playerItems.filter(i => i !== "package02_damaged");
                        localStorage.setItem("playerItems", JSON.stringify(playerItems));

                        showDialogue("提交：送貨失敗", price);
                        return;
                    }

                    takenMissions = takenMissions.filter((m) => m.id !== mission.id); // 清除任務
                    localStorage.setItem("takenMissions", JSON.stringify(takenMissions));
                    
                // 懸賞逃犯
                } else if (mission.id === "task03") {
                    // 如果隊伍中有逃犯，就標記為完成
                    let wantedList = JSON.parse(localStorage.getItem("wantedList")) || [];
                    let prisoners = teamMembers.some(member => wantedList.includes(member.name));

                    if (prisoners) {
                        mission.status = "success";
                    } else {
                        mission.status = "";
                    }
                
                // 狩獵哥布林
                } else if (mission.id === "task04") {
                    // 如果隊伍中有哥布林，就標記為完成
                    let prisoners = teamMembers.filter(m => m.name.includes("哥布林"));
                    if (prisoners.length > 0) {
                        mission.status = "success";
                    } else {
                        mission.status = "";
                    }

                // 收集種子
                } else if (mission.id === "task05") {
                    // 如果物品中有10個種子，就標記為完成
                    let seedCount = playerItems.filter(i => i === "manEaterSeed").length;
                    if (seedCount >= 10) {
                        mission.status = "success";
                    } else {
                        mission.status = "";
                    }
                
                // 失竊的紅寶石
                } else if (mission.id === "quest01") {
                    // 如果物品中有紅寶石，就標記為完成
                    let ruby = playerItems.find(i => i === "devilGem01" || i === "devilGem02");
                    if (ruby) {
                        mission.status = "success";
                    } else {
                        mission.status = "";
                    }

                // 吸血鬼擄走的孩子
                } else if (mission.id === "quest02") {
                    // 如果馬卡斯已死，就標記為完成
                    if (isTrue('馬卡斯已死')) {
                        mission.status = "success";
                    } else {
                        mission.status = "";
                    }

                }
            });

            // 檢查是否陪雷納德見夥伴
            if (isTrue('陪雷納德見夥伴1') && !isTrue('陪雷納德見夥伴2') && playerPos.id === "town01") {
                showDialogue("陪雷納德見夥伴1");
            }
            if (isTrue('陪雷納德見夥伴2') && !isTrue('陪雷納德見夥伴3') && playerPos.id === "town02") {
                showDialogue("陪雷納德見夥伴2");
            }

            //console.log(takenMissions);
            localStorage.setItem("takenMissions", JSON.stringify(takenMissions));
        }

        // 顯示任務列表
        function showMissionList(type) {
            // 顯示說明
            document.getElementById("text").textContent = type === "task" ? texts.tasks : texts.quests;

            // 讀取主角位置、已接任務、已完成的任務
            const playerPos = JSON.parse(localStorage.getItem("playerPos"));
            let takenMissions = JSON.parse(localStorage.getItem("takenMissions")) || [];
            let completedMissions = JSON.parse(localStorage.getItem("completedMissions")) || [];

            // 篩選要顯示的任務
            let filteredMissions = missions.filter(mission => 
                mission.type === type && // 篩選類型
                mission.startPos.includes(playerPos.id) && // 篩選地點
                !completedMissions.includes(mission.id) // 排除已完成的任務
            );

            // 顯示列表
            const menu = document.getElementById("list");
            menu.innerHTML = "";

            filteredMissions.forEach(mission => {

                let extraInfo = "";

                // 懸賞逃犯
                if (mission.id === "task03") {
                    // 如果逃犯資料未滿 3 筆，就隨機補充
                    let wantedList = JSON.parse(localStorage.getItem("wantedList")) || [];
                    while (wantedList.length < 3) {
                        let nameIndex = Math.floor(Math.random() * name.length);
                        let adjIndex = Math.floor(Math.random() * adj.length);
                        let newWanted = adj[adjIndex] + name[nameIndex]; // 新逃犯

                        // 確保不重複
                        if (!wantedList.includes(newWanted)) {
                            wantedList.push(newWanted);
                        }
                    }
                    localStorage.setItem("wantedList", JSON.stringify(wantedList));

                    // 插入逃犯名單
                    extraInfo = `<br><br>${wantedList.map(name => `
                        👤 ${name}
                    `).join("<br>")}`;
                }

                // 任務欄位
                let missionDiv = document.createElement("div");
                missionDiv.classList.add("mission");

                missionDiv.innerHTML = `
                    <hr>
                    <div>
                        <h3>📜 ${mission.name}</h3>
                        ${mission.description}
                        ${extraInfo}
                        <p>報酬： $${mission.price}</p>
                        <div id="${mission.id}-btn" class="menu"></div>
                    </div>
                `;
                menu.appendChild(missionDiv);

                // 檢查任務是否已經承接
                let isTaken = takenMissions.some(taken => taken.id === mission.id);
        
                // 讀取任務的完成狀態
                let takenMission = takenMissions.find(taken => taken.id === mission.id);
                if (takenMission) {
                    mission.status = takenMission.status;
                }

                // 根據任務狀態顯示對應的按鈕
                    let button = document.getElementById(`${mission.id}-btn`);
                    if (mission.status === "success" || mission.status === "fail") {
                        button.innerHTML = `
                            <button onclick="reportMission('${mission.id}')">提交結果</button>
                        `;
                    } else if (isTaken) {
                        button.innerHTML = `
                            <p class="note center">進行中</p>
                        `;
                    } else {
                        button.innerHTML = `
                            <button onclick="takeMission('${mission.id}')">承接</button>
                            ${mission.type === "quest" ? `
                                <button onclick="(takeMission('${mission.id}'), showDialogue('組隊承接'))">組隊承接</button>
                            ` : "" }
                        `;
                    }
                    //console.log(`任務 ${mission.id} | 狀態: ${mission.status}`);

                // 如果是送貨任務，顯示包裹列表
                if ((mission.id === "task01" || mission.id === "task02") && isTaken) {
                    showPackageMenu(mission.id);
                }
            });
            //console.log(takenMissions);
        }

        // 承接任務
        function takeMission(missionId) {
            // 檢查是否已接其他委託
            let takenMissions = JSON.parse(localStorage.getItem("takenMissions")) || [];
            let hasQuest = takenMissions.some(mission => mission.type === "quest");
            if (hasQuest) {
                alert("已有進行中的委託");
                return;
            }

            // 找到這個任務的資料
            let mission = missions.find(m => m.id === missionId);
                
            // 添加任務資料
            let takenMission = {
                id: mission.id,
                type: mission.type,
                name: mission.name,
                description: mission.description,
                price: mission.price,
            };
            takenMissions.push(takenMission);
            localStorage.setItem("takenMissions", JSON.stringify(takenMissions));

            // 改變按鈕
            let button = event.target;
                button.outerHTML = `<p class="note center">進行中</p>`; // 替換按鈕

            // 如果是送貨任務，隨機決定包裹數量
            if ((mission.id === "task01" || mission.id === "task02")) {
                let packageCount = Math.floor(Math.random() * 4) + 1; // 隨機 1~4 個按鈕
                localStorage.setItem("packageCount", packageCount);
            }

            checkMissions();
            showMissionList(mission.type); // 重新顯示任務列表
        }

        // 計算組隊分成
        function shareReward() {
            // 計算組隊的冒險者人數
            const teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];
            const adventurers = teamMembers.filter(m => m.type === "冒險者");

            // 找到委託的資料
            let takenMissions = JSON.parse(localStorage.getItem("takenMissions")) || [];
            let quest = takenMissions.find(mission => mission.type === "quest");
            if (quest) {
                quest.sharePrice = Math.round(quest.price / adventurers.length); // 報酬除以人數
            }
            localStorage.setItem("takenMissions", JSON.stringify(takenMissions));
        }

        // 提交任務
        function reportMission(missionId) {
            let takenMissions = JSON.parse(localStorage.getItem("takenMissions")) || [];
            let completedMissions = JSON.parse(localStorage.getItem("completedMissions")) || [];
            let playerItems = JSON.parse(localStorage.getItem("playerItems")) || [];
            let teamMembers = JSON.parse(localStorage.getItem("teamMembers")) || [];
    
            // 找到這個任務的資料
            let mission = missions.find(m => m.id === missionId);

            // 如果是委託，儲存到已完成的任務
            if (mission.type === "quest") {
                completedMissions.push(mission);
                localStorage.setItem("completedMissions", JSON.stringify(completedMissions));
            }

            // 如果是組隊承接，只會拿到分成
            if (mission.sharePrice) mission.price = mission.sharePrice;

            // 移除身分為「冒險者」的同伴
            for (let i = teamMembers.length - 1; i >= 0; i--) { // 用倒序處理，以免移除後 index 改變而漏掉項目
                const member = teamMembers[i];
                if (member.id !== "player" && member.type === "冒險者") {
                    removeCompanion(member.id);
                }
            }

            getItem("$" + mission.price); // 獲得報酬
            takenMissions = takenMissions.filter((m) => m.id !== mission.id); // 清除任務
            localStorage.setItem("takenMissions", JSON.stringify(takenMissions));

            mission.status = ""; // 清除任務狀態
            checkMissions();
            showMissionList(mission.type); // 更新任務列表

            // 懸賞逃犯
            if (missionId === "task03") { 
                // 如果隊伍中有逃犯，列出選單
                let wantedList = JSON.parse(localStorage.getItem("wantedList")) || [];
                let prisoners = teamMembers.filter(member => wantedList.includes(member.name));
                if (prisoners) {
                    document.getElementById("main").style.display = "none"; // 隱藏其他內容
                    document.getElementById("list").innerHTML = ""; // 清除任務列表

                    let menu = document.createElement("div");
                    menu.classList.add("menu");

                    // 顯示要交出誰的訊息
                    let message = document.createElement("p");
                    message.textContent = texts.choosePrisoner;
                    menu.appendChild(message);

                    // 為每個逃犯建立一個按鈕
                    prisoners.forEach((companion, index) => {
                        let button = document.createElement("button");
                        button.textContent = companion.name;

                        button.onclick = function () {
                            // 如果不是俘虜，需要再次確認
                            if (companion.type !== "俘虜") {
                                let confirmMessage = `${companion.name}是你的${companion.type}，確定要把他交出去嗎？`;
                                if (!confirm(confirmMessage)) return;
                            }

                            removeCompanion(companion.id); // 移除選擇的同伴
                            document.body.removeChild(menu);  // 清除選單

                            // 顯示對話
                            if (companion.type !== "俘虜") {
                                if (companion.name.includes("盜賊")) {
                                    showDialogue("背叛盜賊", mission.price, companion.name);
                                } else if (companion.name.includes("獸人")) {
                                    showDialogue("背叛獸人", mission.price, companion.name);
                                } else if (companion.name.includes("狼人")) {
                                    showDialogue("背叛狼人", mission.price, companion.name);
                                } else if (companion.name.includes("吸血鬼")) {
                                    showDialogue("背叛吸血鬼", mission.price, companion.name);
                                }
                            } else {
                                showDialogue("提交：懸賞逃犯", mission.price, companion.name);
                            }
                        };

                        menu.appendChild(button);
                    });

                    // 取消按鈕
                    let cancelButton = document.createElement("button");
                    cancelButton.textContent = "取消";
    
                    cancelButton.onclick = function () {
                        document.body.removeChild(menu); // 清除選單
                        document.getElementById("main").style.display = "block"; // 顯示其他內容
                    };

                    menu.appendChild(cancelButton);
                    document.body.appendChild(menu);
                    goTop();
                }

            // 狩獵哥布林
            } else if (missionId === "task04") { 
                let prisoners = teamMembers.filter(m => m.name.includes("哥布林"));
                if (prisoners.length > 0) {
                    // 如果隊伍中有哥布林，列出選單
                    document.getElementById("main").style.display = "none"; // 隱藏其他內容
                    
                    let menu = document.createElement("div");
                    menu.classList.add("menu");

                    // 顯示要交出誰的訊息
                    let message = document.createElement("p");
                    message.textContent = texts.choosePrisoner;
                    menu.appendChild(message);

                    // 為每個哥布林建立一個按鈕
                    prisoners.forEach(companion => {
                        let button = document.createElement("button");
                        button.textContent = companion.name;

                        button.onclick = function () {
                            // 如果不是俘虜，需要再次確認
                            if (companion.type !== "俘虜") {
                                let confirmMessage = `${companion.name}是你的${companion.type}，確定要把他交出去嗎？`;
                                if (!confirm(confirmMessage)) return;
                            }

                            removeCompanion(companion.id); // 移除選擇的同伴
                            document.body.removeChild(menu);  // 清除選單

                            // 顯示對話
                            if (companion.type !== "俘虜") {
                                showDialogue("背叛哥布林", mission.price, companion.name);
                            } else {
                                showDialogue("提交：狩獵哥布林", mission.price, companion.name);
                            }
                        };

                        menu.appendChild(button);
                    });

                    // 取消按鈕
                    let cancelButton = document.createElement("button");
                    cancelButton.textContent = "取消";
    
                    cancelButton.onclick = function () {
                        document.body.removeChild(menu); // 清除選單
                        document.getElementById("main").style.display = "block"; // 顯示其他內容
                    };

                    menu.appendChild(cancelButton);
                    document.body.appendChild(menu);
                    goTop();
                }

            // 收集種子
            } else if (mission.id === "task05") {
                const seedCount = playerItems.filter(i => i === "manEaterSeed").length; // 計算種子數量
                price = mission.price * 0.1 * seedCount - mission.price; // 扣掉前面給的報酬
                getItem("$" + price); // 獲得剩餘報酬
                loseItem("manEaterSeed", seedCount); // 移除物品
                showDialogue("提交：收集種子", price);

            // 失竊的紅寶石
            } else if (missionId === "quest01") { 
                // 確認是否交出紅寶石
                let confirmMessage = "一旦交出紅寶石就再也拿不回來了，確定要交出去嗎？";
                if (!confirm(confirmMessage)) return;

                addPlayerFame(5); // 名聲上升
                loseItem("devilGem01"); // 移除物品
                loseItem("devilGem02"); // 移除物品
                showDialogue("提交：失竊的紅寶石", mission.price);

            // 吸血鬼擄走的孩子
            } else if (missionId === "quest02") { 
                // 沒有報酬也沒有名聲
                showDialogue("提交：吸血鬼擄走的孩子", mission.price);

            } else if (missionId === "quest03") { 
                // 奴隸的復仇
                // 你完成了任務，獲得了報酬 ${quest.price}。
            } else if (missionId === "quest04") {
                // 協尋丈夫
                // 你帶回了狼人丈夫，獲得了報酬 ${quest.price}。
            }
        }

        // 顯示包裹列表
        function showPackageMenu(missionId) {
            // 找到這個任務的資料
            let mission = missions.find(m => m.id === missionId);
            const price = mission.price * 2; // 賠償金

            // 根據任務判斷包裹id
            const itemId = missionId.replace("task", "package");

            // 讀取攜帶的包裹數量
            const playerItems = JSON.parse(localStorage.getItem("playerItems")) || [];
            const takenCount = playerItems.filter(i => i === itemId).length;
            const damagedCount = playerItems.filter(i => i === `${itemId}_damaged`).length;

            // 讀取包裹數量
            let packageCount = parseInt(localStorage.getItem("packageCount"));
            packageCount -= (takenCount + damagedCount); // 減去攜帶的數量

            // 創建包裹列表
            const menu = document.getElementById(`${missionId}-btn`);
            menu.innerHTML = "";
            let buttonDiv = document.createElement("div");

            // 領取包裹的按鈕
            for (let i = 0; i < packageCount; i++) {
                let button = document.createElement("button"); // 創建按鈕
                button.textContent = "📦 領取包裹";
                button.onclick = function () {
                    getItem(itemId); // 獲得包裹
                    showPackageMenu(missionId);
                };
                buttonDiv.appendChild(button);
            }

            // 退還包裹的按鈕
            for (let i = 0; i < takenCount; i++) {
                let button = document.createElement("button"); // 創建按鈕
                button.textContent = "退還包裹";
                button.onclick = function () {
                    loseItem(itemId); // 失去包裹
                    showPackageMenu(missionId);
                };
                buttonDiv.appendChild(button);
            }

            // 賠償的按鈕
            for (let i = 0; i < damagedCount; i++) {
                let button = document.createElement("button"); // 創建按鈕
                button.textContent = `退還破損包裹（賠償 $${price}）`;
                button.onclick = function () {
                    // 檢查資金
                    if (hasItem("$" + price)) {
                        loseItem("$" + price);
                        loadPartyData();
                    } else {
                        alert("金錢不足");
                        return;
                    }

                    loseItem(`${itemId}_damaged`); // 失去包裹
                    showPackageMenu(missionId);
                };
                buttonDiv.appendChild(button);
            }

            menu.appendChild(buttonDiv);
        }

        // 失物招領
        function lostProperty() {
            // 讀取之前備份的金錢、物品
            const backupMoney = parseInt(localStorage.getItem("playerMoney-backup")) || 0;
            const backupItems = JSON.parse(localStorage.getItem("playerItems-backup")) || [];

            if (backupMoney > 0 || backupItems.length > 0) {
                showDialogue('有失物');
            } else {
                showDialogue('沒有失物');
            }
        }

    </script>

</body>
</html>
